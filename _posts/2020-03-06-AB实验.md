# AB实验显著性
- [AB实验显著性](#ab%e5%ae%9e%e9%aa%8c%e6%98%be%e8%91%97%e6%80%a7)
  - [介绍](#%e4%bb%8b%e7%bb%8d)
  - [置信策略](#%e7%bd%ae%e4%bf%a1%e7%ad%96%e7%95%a5)
    - [人均类](#%e4%ba%ba%e5%9d%87%e7%b1%bb)
    - [留存类](#%e7%95%99%e5%ad%98%e7%b1%bb)
    - [人均类](#%e4%ba%ba%e5%9d%87%e7%b1%bb-1)
    - [SUM类](#sum%e7%b1%bb)
  - [常见分布及关系](#%e5%b8%b8%e8%a7%81%e5%88%86%e5%b8%83%e5%8f%8a%e5%85%b3%e7%b3%bb)
## 介绍
- "原假设正确但是被拒绝"的概率上限为α，[0% 5%]
 - p-value 第一类假设错误，“原假设正确的前提下检验因子落入拒绝域”的概率。只要p-value小于我们事先设定的α，实验在显著性水平上就属达标
- 随机噪声的来源是小样本相对于总体的**抽样误差**，因此，计算显著性水平核心是计算待检指标的**抽样分布**
- 置信策略，就是在用已知（理论计算）或未知（模拟计算）的抽样分布，来对抗抽样误差

## 置信策略

| 指标类型                                 | 置信策略                           |
|------------------------------------------|------------------------------------|
| 人均类(read/user, like/user etc)         | 双样本student-t检验                |
| 留存类                                   | (以正态分布近似的)二项分布几率检验 |
| CTR类（click/view, read/impression etc.) | Bootstrap重采样                    |
| SUM类(总阅读数，总点赞数，总消费数)      | 模拟计算方法                       |

### 人均类
待检假设是比较实验组与对照组某项指标的数学期望是否一致，即样本均值检验，常用手段为[双样本t检验](https://en.wikipedia.org/wiki/Student%27s_t-test)。检验假设实验组和对照组总体方差未知且一致，以**样本方差**代替总体方差，判断两个**总体期望**是否一致。

t检验因子的**鲁棒性质**规避对原分布的假设问题，即t检验因子的有效性在很大程度上并不受样本原总体分布是否严格正态的影响。在实际的应用过程中，关于独立同分布变量和的[中心极限定理](https://en.wikipedia.org/wiki/Central_limit_theorem) 保证了在样本量足够的情况下，使用样本均值进行假设检验的双样本t检验具有一定的健壮性，在大多数情况下我们**无须过多考虑x(实验组)和y(对照组)来源总体的实际分布性质**，即可以进行足够有效的双样本t检验。研究表明针对大多数常见原始分布，t检验的准确性都在可以接受的范围*。
* 参考 Larsen R J, Marx M L. An introduction to mathematical statistics and its applications[M]. Englewood Cliffs, NJ: Prentice-Hall, 1986. Chapter 9 Case 9.2.1

检验设置如下：

### 留存类
- 二元事件(留 or not)
- 根据近似方法的不同，关于二项分布的双样本几率假设检验可以基于卡方分布，也可以基于正态分布
- 采用**正态分布近似**(和人均保持一致)来构建假设检验设置如下：
### 人均类
- 计算单元(click\read)和随机单元(人)不一致，在以人为单位分流的实验里，随机性假设最多做到人这一层。**不同人click不同**
- 在N次view中我们的真实**独立**样本量远没有N这样的规模，那么实际上均值方差随样本量衰减的速度也就远不及1/N的速度。换而言之，类似click/view的指标以事件为颗粒度，使得我们使用传统方法在不可避免地低估均值方差。而低估样本方差直接导致的结果就是过多误召回（在实验中表现在此类指标非常容易显著，哪怕是AA实验，p value<0.05的case远大于5%）。
- 用模拟计算将随机单元与计算单元重新对齐，模拟方法为[bootstrap](https://en.wikipedia.org/wiki/Bootstrapping_(statistics))的重采样
  - 既然我们已知的，关于总体的信息100%存在于获得的样本中。
  - 那么，试图重构总体最好的方法就是对我的样本进行重复采样，不断的对样本进行有放回地抽样从而制造新样本。
    - 例如我有一个大小为100的某样本，不断有放回地抽样，满100次即宣告这是一组新样本，重复1000次得到1000组重采样的样本。
  - 可以证明，在重采样本组数足够多时，某个统计量本身的抽样方差就可以用其在这些重采样样本间的方差进行无偏估计，对应置信度的计算就从经典统计学基于某一确定分布的分位点比较转为类似蒙特卡洛方法的数值模拟计算。
  - 把non-per-user指标mapping回我们的最小随机单元（per user）中，然后以人为单位进行bootstrap重采样，在每一组重采样的人群样本中计算这个指标的某统计量，最后计算该统计量的在多个重采样样本中的组间方差来作为其抽样方差的无偏估计
  - 节省算力的方法：[ Bag of Little Bootstraps (BLB)](https://arxiv.org/abs/1112.5016)

### SUM类
SUM类指标是一种比较tricky的指标类型，它有两个复杂之处：

1. 统计量对样本量敏感，随采样样本量变化而变化，是两个变量的乘积（人均指标*人数）
2. 即使在50%试验条件下，分流样本数仍然是一个随机变量（两组人数大概率不会完全相等）

通过SUM类指标想衡量的通常是某个变动对人均指标和访问人数（留存）的综合影响。

举例：某个策略

1. 拉低了人均阅读（从read/u指标置信看出）
2. 提高了留存，带来了更多的uv（从进组用户数指标看出

那么：1&&2的综合作用下总阅读数大盘的变化如何？

SUM指标考量人均和留存两者的综合作用（乘积）。在上面的case里，表现可能是：
   1. 它对实验者的回答可能是下降（人均阅读降低的负贡献比用户增加的正贡献更大）
   2. 可能是上升（人均阅读降低的负贡献没有用户增加的正贡献大）
   3. 甚至也可能是不变（两者贡献刚好相抵消）

需要通过这个指标向用户准确客观地传递这三种信息之一

根据上述观察指标的实际需求，我们设计了如下的置信策略：SUM类指标的置信策略比较“我啥都不做应该是多少”和“我目前是多少”

由于 SUM(READ) = READ/USER * USER_NUM

在备则假设下（什么都没做/aa试验），随机变量SUM(READ)的正常波动受到两个随机因子的共同影响：
  * 均值的抽样误差
  * 分流的二项分布误差，
且这两个因子具有两个很好的数学特性，
1. 我们比较清楚地知道两个因子各自的抽样分布情况：
     1. READ/USER 是一个服从N(miu, sigma/sqrt(n))正态分布的随机变量（样本均值的中心极限定理）
     2. 在分流条件下，USER_NUM 是一个服从B(N_total,0.5)二项分布的随机变量（按1:1进行分流）
2. 两者之间相互独立（发生行为的用户对实验进组用户数是无感的）

我们现在的工作就变成了：如何得到一个参数确定的正态分布和一个参数确定的二项分布的乘积的概率分布？
这不是经典统计学有完整研究的分布类型，但是在计算机的帮助下我们可以继续借助模拟计算的思想来解决这个问题：由于两个分布独立且确定，我只需要
  1. 把它们分别赋给两个变量，
  2. 然后分别获得随机值，相乘，记录，
  3. 重复很多遍，我们就可以模拟出乘积随机变量的概率密度函数。

如此借助类似重采样的思想，
  1. 获得的概率密度函数就是什么都没做的情况下SUM指标的（正常）波动范围，
  2. 比较实际的SUM指标在这个范围内的某一分位点，
  3. 就可以判定SUM值的p值。

## 常见分布及关系
![Image of distribution logo](images/distribution.png)
